@model List<string>
@{
    ViewData["Title"] = "Upload and Merge Images";
}

<h2>Upload Images</h2>

<form asp-action="Upload" method="post" enctype="multipart/form-data">
    <input type="file" name="files" multiple accept="image/*" />
    <button type="submit">Upload</button>
</form>

@if (TempData["Error"] != null)
{
    <div style="color:red">@TempData["Error"]</div>
}
@if (TempData["Success"] != null)
{
    <div style="color:green">@TempData["Success"]</div>
}
@if (TempData["MergedFile"] != null)
{
    <div style="margin-top: 15px;">
        <strong>Merged Output:</strong><br />
        <video width="640" controls>
            <source src="/converted/@TempData["MergedFile"]" type="video/mp4" />
        </video>
    </div>
}

@if (Model.Any())
{
    <h3>Uploaded Images (Select & Drag to Reorder)</h3>

    <form id="imageForm" method="post">
        <div id="imageList" style="display: flex; flex-wrap: wrap; gap: 10px;">
            @foreach (var file in Model)
            {
                <div class="image-box" style="width: 150px; border: 1px solid #ccc; padding: 5px;">
                    <input type="checkbox" name="selectedImages" value="@file" />
                    <img src="/uploads/@file" style="width: 100%; height: auto;" />
                    <div style="text-align:center; font-size: 0.8em;">@file</div>
                </div>
            }
        </div>

        <button type="submit" class="btn btn-primary">Create Slideshow</button>
    </form>
}
<div id="result" style="margin-top: 20px;"></div>
<div id="overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; color:white; text-align:center; padding-top:200px;">
    <h3 id="progressText">Initializing...</h3>
    <div style="width:50%; margin:auto; background:#444; border-radius:5px;">
        <div id="progressBar" style="width:0%; height:20px; background:limegreen; transition:0.3s;"></div>
    </div>
</div>
<style>
    .video-item.selected {
        border: 2px solid limegreen;
        background-color: #f3fff3;
    }

.spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(0,0,0,0.1);
    border-left-color: #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
}

@@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

@section Scripts {
<script>
document.getElementById('imageForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const resultDiv = document.getElementById('result');
    
    resultDiv.innerHTML = `<div class="text-center"><div class="spinner"></div><p>Processing your slideshow...</p>                               </div>
                           `;

    try {
        const response = await fetch('/uploaded/MergeSelectedImages', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('Merge failed');

        const data = await response.json();
        resultDiv.innerHTML = `
            <h4>Video Created!</h4>
            <video controls width="480" style="display:block; margin-bottom:10px;">
                <source src="${data.url}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <a href="${data.url}" class="btn btn-success" download>Download Video</a>
        `;
    } catch (err) {
        resultDiv.innerHTML = `<p class="text-danger">Error: ${err.message}</p>`;
    }
});
</script>
}

